---

- name: Import role - karlmdavis.bind-dns
  ansible.builtin.import_role:
    name: karlmdavis.bind-dns
  vars:
    eddings_public_ip: "{{ hostvars['eddings.justdavis.com']['public_ip_address'] }}"
    eddings_private_ip: "{{ hostvars['eddings.justdavis.com']['private_ip_address'] }}"
    reverse_zone_name: "{{ eddings_public_ip.split('.')[2] + '.' + eddings_public_ip.split('.')[1] + '.' + eddings_public_ip.split('.')[0] + '.in-addr.arpa' }}"
    zones:
      - {name: "{{ domain }}", template_source: 'roles/dns_server/templates/db.justdavis.com.j2'}
      - {name: "intranet.{{ domain }}", template_source: 'roles/dns_server/templates/db.intranet.justdavis.com.j2'}
      - {name: "{{ domain_doh }}", template_source: 'roles/dns_server/templates/db.davisonlinehome.name.j2'}
      - {name: "{{ domain_rps }}", template_source: 'roles/dns_server/templates/db.rpstourney.com.j2'}
      - {name: "{{ domain_sw }}", template_source: 'roles/dns_server/templates/db.storywyrm.com.j2'}
      - {name: "preview.{{ domain_sw }}", template_source: 'roles/dns_server/templates/db.preview.storywyrm.com.j2'}
      - {name: "{{ reverse_zone_name }}", template_source: 'roles/dns_server/templates/db.reverse_zone.j2'}
    forwarders:
      # Google's Public DNS Servers: https://developers.google.com/speed/public-dns/
      - 8.8.8.8
      - 8.8.4.4
    zone_transfer_peers:
      # Gandi's ns6.gandi.net secondary name server
      - 217.70.177.40

# DNS Server Firewall Configuration.
#
# Goal: Allow public DNS queries while relying on BIND's built-in protections.
#
# Reasoning:
# - Port 53 (DNS): Must be publicly accessible for authoritative DNS service.
# - Serves multiple domains: justdavis.com, davisonlinehome.name, rpstourney.com, storywyrm.com.
# - DNS queries can be legitimately rapid (e.g., browser loading page with many subdomains).
#
# Rate Limiting Decision: NO rate limiting on DNS.
# - Legitimate use cases generate rapid queries (web page with multiple resources from subdomains).
# - Rate limiting could break legitimate DNS resolution and cause website/email failures.
# - BIND9 has built-in DoS protections:
#   - Query rate limiting (RRL) built into BIND
#   - Response rate limiting to prevent DNS amplification attacks
#   - Client query limits per IP
#
# Tradeoffs:
# - Rely on BIND's application-level protections rather than kernel-level rate limiting.
# - BIND is specifically designed to handle high query volumes safely.
# - UFW rate limiting is too coarse-grained for DNS (can't distinguish legitimate from attack traffic).
#
# Security benefit: BIND's RRL (Response Rate Limiting) specifically designed for DNS DoS protection.
# This is more effective than generic connection rate limiting.
- name: Firewall - Allow DNS Traffic
  community.general.ufw:
    rule: allow
    name: Bind9
  become: true

- name: Ensure Stub OpenDKIM Records Exist
  ansible.builtin.copy:
    content: ''
    dest: "/etc/bind/dkim-{{ item }}.record"
    force: false
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  become: true
  with_items:
    - "{{ domain }}"
    - "{{ domain_doh }}"
  notify:
    - Restart bind9

- name: Import tasks - test.yml
  ansible.builtin.import_tasks: test.yml
  tags: test
