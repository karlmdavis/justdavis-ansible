---

- name: Install
  ansible.builtin.apt:
    name: "{{ item }}"
    update_cache: true
    cache_valid_time: "{{ 60 * 15 }}"
  with_items:
    - samba
    # The client is needed in our tests.
    - smbclient
  become: true

# Samba File Sharing Firewall Configuration.
#
# Goal: Restrict file sharing to trusted networks only.
#
# Reasoning:
# - Ports 137-139: NetBIOS services for Windows file sharing compatibility.
# - Port 445: SMB/CIFS direct file sharing (modern Windows/macOS/Linux clients).
# - File shares contain private family data and should never be internet-accessible.
#
# Tradeoffs:
# - Users can only access file shares from LAN or Tailscale VPN (not directly from internet).
# - This is the CORRECT configuration - file shares should NEVER be exposed to internet.
# - Note: Samba daemon is configured to bind only to localhost and LAN interface, so this is
#   defense-in-depth (application-level binding + firewall restriction).
#
# Security benefit: Critical protection against ransomware and data theft.
# Internet-exposed SMB shares are a primary target for automated attacks and have been the
# source of numerous high-profile breaches (e.g., WannaCry, NotPetya).
- name: Firewall - Allow Samba from LAN and Tailscale
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
    from_ip: "{{ item.source }}"
    comment: "Samba - {{ item.name }}"
  become: true
  loop:
    - { port: '137', proto: 'udp', source: "{{ network_home_private_cidr }}", name: 'LAN' }
    - { port: '138', proto: 'udp', source: "{{ network_home_private_cidr }}", name: 'LAN' }
    - { port: '139', proto: 'tcp', source: "{{ network_home_private_cidr }}", name: 'LAN' }
    - { port: '445', proto: 'tcp', source: "{{ network_home_private_cidr }}", name: 'LAN' }
    - { port: '137', proto: 'udp', source: '100.64.0.0/10', name: 'Tailscale' }
    - { port: '138', proto: 'udp', source: '100.64.0.0/10', name: 'Tailscale' }
    - { port: '139', proto: 'tcp', source: '100.64.0.0/10', name: 'Tailscale' }
    - { port: '445', proto: 'tcp', source: '100.64.0.0/10', name: 'Tailscale' }
