---

- name: Install Prerequisites
  apt:
    name: "{{ item }}"
  become: true
  with_items:
    # Some integration tests run in Jenkins will use a PostgreSQL DB.
    # The psycopg2 lib is needed by Ansible's postgresql_db module.
    - [postgresql, postgresql-client, python-psycopg2]

- name: Create Database User
  postgresql_user:
    name: "{{ vault_postgres_builds_username }}"
    password: "{{ vault_postgres_builds_password }}"
    role_attr_flags: 'CREATEDB'
  become: true
  become_user: postgres

- name: Create/Update Jenkins Jobs
  jenkins_script:
    url: "{{ jenkins_url_local }}"
    user: "{{ jenkins_dynamic_admin_username | default(omit) }}"
    password: "{{ jenkins_dynamic_admin_password | default(omit) }}"
    script: "{{ lookup('template', 'templates/configureJobs.groovy.j2') }}"
  register: jenkins_script_jobs
  changed_when: "(jenkins_script_jobs | success) and 'Changed' in jenkins_script_jobs.output"
