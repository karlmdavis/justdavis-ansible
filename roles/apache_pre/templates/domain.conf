<VirtualHost *:80>
  ServerName {{ domain }}
{% for alias in domain_site_aliases %}
  ServerAlias {{ alias }}
{% endfor %}
  
  DocumentRoot /var/apache2/{{ domain }}/www/
  ErrorLog /var/apache2/{{ domain }}/logs/error_log
  TransferLog /var/apache2/{{ domain }}/logs/access_log
  
  ServerAdmin {{ domain_webmaster }}
  
  # Ensure that Let's Encrypt's challenge docs are accessible.
  <Directory /var/apache2/{{ domain }}/www/.well-known/acme-challenge>
    <RequireAll>
      Require all granted
    </RequireAll>
  </Directory>

  # Redirect all HTTP (port 80) traffic for this virtual host to HTTPS.
  # (Exempt the path used by Let's Encrypt.)
  # Reference: https://wiki.apache.org/httpd/RedirectSSL
  RedirectMatch permanent ^(?!\/\.well-known\/acme-challenge).*$ https://{{ domain }}/
</VirtualHost>

