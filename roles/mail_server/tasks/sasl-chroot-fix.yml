---

##
# Postfix on Debian is not properly configured to run `saslauthd`: the `smtpd`
# service is (by default) run inside a chroot environment at
# `/var/spool/postfix/`, which doesn't have access to the SASL socket file.
#
# The standard Debian solution is to configure saslauthd to create its socket
# directly inside the Postfix chroot at `/var/spool/postfix/var/run/saslauthd`.
# This requires creating the directory structure and setting proper permissions
# so both Postfix and saslauthd can access it.
#
# Reference: /etc/default/saslauthd comments on Debian/Ubuntu systems.
##

- name: Add 'postfix' User to 'sasl' Group
  ansible.builtin.user:
    name: postfix
    groups: sasl
    append: true
  become: true

- name: Create `/var/run` Directory in Postfix chroot
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    owner: root
    group: root
    mode: u=rwx,g=rx,o=rx
  with_items:
    - /var/spool/postfix/var
    - /var/spool/postfix/var/run
  become: true

- name: Create SASL Directory in Postfix chroot
  ansible.builtin.file:
    state: directory
    path: /var/spool/postfix/var/run/saslauthd
    owner: root
    group: sasl
    mode: u=rwx,g=rwx,o=
  become: true

- name: Verify dpkg Override for SASL Directory
  ansible.builtin.command:
    cmd: dpkg-statoverride --list /var/spool/postfix/var
  register: dpkg_override_postfix_var
  changed_when: false
  failed_when: false

- name: Configure dpkg to Handle SASL Directory Correctly
  ansible.builtin.command:
    cmd: dpkg-statoverride --add root root 755 /var/spool/postfix/var
  become: true
  when: dpkg_override_postfix_var.rc != 0
