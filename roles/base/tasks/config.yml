---

- name: Install SSH Security Modules
  ansible.builtin.apt:
    name: "{{ item }}"
    update_cache: true
    cache_valid_time: "{{ 60 * 15 }}"
  with_items:
    - fail2ban
  become: true

- name: Configure fail2ban jails
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 1h
      findtime = 10m
      maxretry = 5

      [sshd]
      enabled = true

      [apache-auth]
      enabled = true
      port = http,https

      [apache-noscript]
      enabled = true
      port = http,https

      [apache-overflows]
      enabled = true
      port = http,https

      [apache-badbots]
      enabled = true
      port = http,https

      [postfix]
      enabled = true
      port = smtp,submission

      [dovecot]
      enabled = true
      port = pop3,imap,imaps,pop3s
    mode: u=rw,g=r,o=r
  become: true
  notify: Restart fail2ban

- name: Configure kernel security parameters
  ansible.builtin.copy:
    dest: /etc/sysctl.d/99-security.conf
    content: |
      # Protect against SYN flood attacks
      net.ipv4.tcp_syncookies = 1

      # Ignore ICMP redirects
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv6.conf.all.accept_redirects = 0

      # Ignore source-routed packets
      net.ipv4.conf.all.accept_source_route = 0
      net.ipv6.conf.all.accept_source_route = 0

      # Log Martian packets (impossible addresses)
      net.ipv4.conf.all.log_martians = 1

      # Ignore ICMP ping requests
      net.ipv4.icmp_echo_ignore_all = 0

      # Ignore bogus ICMP error responses
      net.ipv4.icmp_ignore_bogus_error_responses = 1

      # Enable reverse path filtering (prevent IP spoofing)
      net.ipv4.conf.all.rp_filter = 1
      net.ipv4.conf.default.rp_filter = 1
    mode: u=rw,g=r,o=r
  become: true
  notify: Load security sysctl configuration

# SSH Firewall Configuration with Rate Limiting.
#
# Goal: Allow remote administration while preventing brute force attacks.
#
# Reasoning:
# - Port 22 (SSH): Required for remote server administration and emergency access.
# - Primary attack vector: Automated brute force attempts from internet.
# - Rate limiting: Prevents rapid connection attempts (6+ connections in 30 seconds per IP).
#
# Tradeoffs:
# - Rate limiting could affect: Legitimate users rapidly reconnecting (e.g., automation, testing).
# - Rate limiting does NOT affect: Normal SSH usage (persistent connections, occasional reconnects).
# - fail2ban provides additional protection by analyzing auth logs for repeated login failures.
#
# Security benefit: Two-layer protection against SSH brute force:
# 1. UFW rate limiting blocks rapid connection attempts at kernel level
# 2. fail2ban analyzes SSH logs and bans IPs with repeated auth failures
# Together these have blocked 38,000+ SSH attack attempts and 3,600+ IPs.
- name: Firewall - Allow SSH incoming traffic with rate limiting
  community.general.ufw:
    rule: limit
    name: OpenSSH
  become: true
  when: "'Microsoft' not in ansible_kernel"

- name: Firewall - Enable
  community.general.ufw:
    state: enabled
  become: true
  when: "'Microsoft' not in ansible_kernel"

- name: Configure Timezone
  ansible.builtin.template:
    src: templates/timezone.j2
    dest: /etc/timezone
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  become: true
  register: timezone_file
  when: "'Microsoft' not in ansible_kernel"

- name: Apply Timezone Change
  ansible.builtin.command:
    cmd: /usr/sbin/dpkg-reconfigure --frontend noninteractive tzdata
  become: true
  when: "timezone_file.changed and 'Microsoft' not in ansible_kernel"

- name: Install 'ntp' and Other Base Packages
  ansible.builtin.apt:
    name: "{{ item }}"
    update_cache: true
    cache_valid_time: "{{ 60 * 15 }}"
  with_items:
    - ntp
  become: true
  when: "'Microsoft' not in ansible_kernel"

- name: Configure 'hosts'
  ansible.builtin.lineinfile:
    dest: /etc/hosts
    regexp: '^127.0.1.1'
    line: "127.0.1.1 {{ inventory_hostname_short }}.{{ domain }} {{ inventory_hostname_short }}"
  become: true

- name: Configure 'hostname' (permanent)
  ansible.builtin.copy:
    dest: /etc/hostname
    content: "{{ inventory_hostname_short }}"
  register: hostname_file
  become: true
  when: "'Microsoft' not in ansible_kernel"

- name: Configure 'hostname' (transient)
  ansible.builtin.command:
    cmd: "/usr/bin/hostnamectl set-hostname {{ inventory_hostname_short }}"
  become: true
  when: "hostname_file.changed and 'Microsoft' not in ansible_kernel"

- name: Auto Upgrade - Install
  ansible.builtin.apt:
    name: "{{ item }}"
    update_cache: true
    cache_valid_time: "{{ 60 * 15 }}"
  with_items:
    - unattended-upgrades
  become: true

- name: Auto Upgrade - Configure
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "/etc/apt/apt.conf.d/{{ item.dest }}"
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  with_items:
    - { src: '50unattended-upgrades.j2', dest: '50unattended-upgrades' }
    - { src: '20auto-upgrades.j2', dest: '20auto-upgrades' }
  become: true

- name: Install Expect Utility
  ansible.builtin.apt:
    name: "{{ item }}"
    update_cache: true
    cache_valid_time: "{{ 60 * 15 }}"
  with_items:
    # These two packages are used by several other server & client roles.
    # Note: The Ansible expect module can't be used on all clients, due to https://github.com/ansible/ansible/issues/23851.
    - expect
    - python3-pexpect
  become: true

# Ansible's `become_user` feature requires the `setfacl` command.
- name: Install ACL Utilities
  ansible.builtin.package:
    name: acl
    state: present
  become: true
  when:
    - ansible_distribution == 'Ubuntu'
    - ansible_distribution_version == '14.04'

- name: Install Standard Tools
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  with_items:
    - git
    - vim
    - build-essential
  become: true

- name: Add GitHub to the Global ssh_known_hosts
  ansible.builtin.known_hosts:
    path: /etc/ssh/ssh_known_hosts
    name: github.com
    key: "{{ ssh_known_host_github }}"
  become: true

# Bizarrely, this is required prior to Ubuntu 17.02, per <https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1618188>.
- name: Create systemd-journal Storage Directory
  ansible.builtin.file:
    path: /var/log/journal
    state: directory
    owner: root
    group: systemd-journal
  become: true
  when:
    - ansible_distribution == 'Ubuntu'
  register: mkdir_var_log_journal

- name: Configure systemd-journal Storage Directory
  ansible.builtin.command:
    cmd: /bin/systemd-tmpfiles --create --prefix /var/log/journal
  become: true
  when: mkdir_var_log_journal.changed

- name: Apply systemd-journal Storage Configuration
  ansible.builtin.command:
    cmd: /usr/bin/killall -USR1 systemd-journald
  become: true
  when: mkdir_var_log_journal.changed
